<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>THE LAST ONEï¼šæ „å…‰ã®æœ€ä¸‹ä½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Yusei+Magic&display=swap');

        /* åŸºæœ¬è¨­å®š */
        body {
            font-family: 'Yusei Magic', sans-serif;
            background-color: #111827;
            user-select: none; 
            overflow: hidden;
            height: 100dvh; 
            width: 100vw;
            touch-action: manipulation;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .font-pop {
            font-family: 'Mochiy+Pop+One', sans-serif;
        }

        /* --- 3Dã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®š --- */
        .stage-container {
            perspective: 800px;
            overflow: hidden;
            background: linear-gradient(to bottom, #3b82f6 0%, #93c5fd 40%, #4ade80 40%, #15803d 100%);
            transition: all 1s ease;
            position: relative;
            width: 100%;
            height: 100%;
        }

        .sky-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 50%;
            background: linear-gradient(to bottom, #2563eb, #60a5fa);
            z-index: 0;
        }
        
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50px;
            animation: moveCloud linear infinite;
        }
        @keyframes moveCloud {
            from { transform: translateX(100vw); }
            to { transform: translateX(-300px); }
        }

        /* åœ°é¢ */
        .ground-plane {
            position: absolute;
            top: 30%; 
            left: -10%; 
            width: 120%; 
            height: 60%; 
            background-color: #4ade80;
            transform-origin: 50% 50%;
            transform: rotateX(25deg) scale(0.9); 
            transform-style: preserve-3d;
            z-index: 1;
            transition: transform 2s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            background-image: 
                linear-gradient(rgba(255,255,255,0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.2) 1px, transparent 1px);
            background-size: 60px 60px;
        }
        
        @media (min-width: 768px) {
            .ground-plane {
                top: 35%;
                left: 0;
                width: 100%;
                height: 70%;
                transform: rotateX(30deg) scale(0.95);
                background-size: 80px 80px;
            }
        }

        /* ãƒ•ã‚§ãƒ³ã‚¹ */
        .fence-back {
            position: absolute;
            top: -20px; left: -5%; width: 110%; height: 30px;
            background: repeating-linear-gradient(90deg, #fff, #fff 10px, transparent 10px, transparent 30px);
            border-top: 4px solid white;
            border-bottom: 4px solid white;
            transform: rotateX(-30deg); 
            z-index: 2;
        }

        /* ãƒ¬ãƒ¼ãƒ³ */
        .lane {
            position: relative; width: 100%; height: 20%;
            border-bottom: 2px dashed rgba(255, 255, 255, 0.4);
            display: flex; align-items: center;
            background-color: rgba(255,255,255,0.02);
        }
        .lane:last-child { border-bottom: none; }
        .lane:nth-child(even) { background-color: rgba(0,0,0,0.05); }

        /* ã‚´ãƒ¼ãƒ«ãƒã‚¹ãƒˆ */
        .goal-post-container {
            position: absolute; top: -50px; bottom: 0; left: 85%; width: 10px;
            transform-style: preserve-3d; z-index: 20;
        }
        .finish-line {
            position: absolute; top: 0; bottom: 0; width: 100%;
            background: repeating-linear-gradient(90deg, #fff, #fff 10px, #000 10px, #000 20px);
            opacity: 0.8;
        }
        .goal-post-pillar {
            position: absolute; width: 12px; 
            height: 140px; 
            background: repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #fff 10px, #fff 20px);
            bottom: 0; transform: rotateX(-25deg); transform-origin: bottom center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
        .goal-pillar-left { left: -25px; }
        .goal-pillar-right { left: 25px; bottom: -10px; z-index: 30; }
        .goal-banner {
            position: absolute; 
            top: -110px; 
            left: -40px; width: 100px;
            background: #ef4444; color: white; text-align: center; font-weight: bold;
            padding: 5px; transform: rotateX(-25deg); border: 2px solid white;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3); font-family: 'Mochiy+Pop+One', sans-serif;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ */
        .start-line {
            position: absolute; top: 0; bottom: 0; left: 5%; width: 6px; 
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            z-index: 5;
        }

        /* --- é¦¬ (ã‚µã‚¤ã‚ºèª¿æ•´: è¦–èªæ€§å‘ä¸Š) --- */
        .horse-actor {
            position: absolute;
            left: 5%;
            top: 50%;
            transform-style: preserve-3d;
            transition: left 0.1s linear;
            will-change: left;
            z-index: 10;
            
            /* ã‚¹ãƒãƒ›: 50px -> 70px ã«æ‹¡å¤§ */
            width: 70px;
            margin-left: -35px;
            margin-top: -30px; /* é‡å¿ƒèª¿æ•´ */
        }
        
        /* PC: 80px -> 100px ã«æ‹¡å¤§ */
        @media (min-width: 768px) {
            .horse-actor {
                width: 100px; 
                margin-left: -50px;
                margin-top: -45px;
            }
        }

        .horse-billboard {
            transform: rotateX(-25deg) translateY(-40%); 
            transform-origin: 50% 100%;
            position: relative;
            display: block;
            text-align: center;
        }

        @keyframes sprint {
            0% { transform: scaleX(-1) translateY(0) rotate(0deg); }
            25% { transform: scaleX(-1) translateY(-6px) rotate(-5deg); }
            50% { transform: scaleX(-1) translateY(-2px) rotate(0deg); }
            75% { transform: scaleX(-1) translateY(-8px) rotate(5deg); }
            100% { transform: scaleX(-1) translateY(0) rotate(0deg); }
        }
        
        .galloping-sprite {
            /* ã‚¹ãƒãƒ›: ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºæ‹¡å¤§ */
            font-size: 3.8rem; 
            filter: drop-shadow(2px 4px 3px rgba(0,0,0,0.4));
            animation: sprint 0.35s infinite linear; line-height: 1; z-index: 10;
            display: inline-block; 
        }
        @media (min-width: 768px) {
            .galloping-sprite {
                /* PC: ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºæ‹¡å¤§ */
                font-size: 6rem; 
                filter: drop-shadow(4px 6px 5px rgba(0,0,0,0.4));
            }
        }

        .horse-shadow {
            background: rgba(0,0,0,0.3); border-radius: 50%;
            transform: rotateX(80deg) translateY(10px); 
            filter: blur(4px); 
            
            /* å½±ã‚‚å°‘ã—å¤§ãã */
            width: 40px; height: 8px; margin: -15px auto 0 auto;
        }
        @media (min-width: 768px) {
            .horse-shadow {
                width: 60px; height: 16px; margin: -25px auto 0 auto;
                filter: blur(6px);
            }
        }

        /* --- é¦¬åãƒ©ãƒ™ãƒ« (å…¨è¡¨ç¤ºå¯¾å¿œãƒ»è¦–èªæ€§å‘ä¸Š) --- */
        .name-label {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold; 
            color: #fff; 
            background: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(4px);
            border-radius: 6px; 
            white-space: nowrap; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 30; 
            display: flex; align-items: center; 
            backface-visibility: hidden;
            
            /* å¹…åˆ¶é™ã‚’æ’¤å»ƒã—ã¦å…¨ã¦è¡¨ç¤º */
            width: max-content;
            max-width: none;
            
            /* ã‚¹ãƒãƒ› */
            bottom: 60px;
            font-size: 0.7rem;
            padding: 2px 8px;
            gap: 3px;
            border: 1.5px solid white;
        }
        @media (min-width: 768px) {
            /* PC */
            bottom: 85px;
            font-size: 0.9rem;
            padding: 4px 12px;
            gap: 6px;
            border: 2px solid white;
        }

        .name-number {
            display: inline-block; text-align: center; border-radius: 50%; color: white; flex-shrink: 0;
            /* ç•ªå·ã‚µã‚¤ã‚ºèª¿æ•´ */
            width: 14px; height: 14px; line-height: 14px; font-size: 0.65rem;
        }
        @media (min-width: 768px) {
            .name-number {
                width: 18px; height: 18px; line-height: 18px; font-size: 0.8rem;
            }
        }

        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
        #countdown-overlay {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            z-index: 60; pointer-events: none; text-shadow: 0 4px 0 #000;
        }
        .count-number {
            font-family: 'Mochiy+Pop+One', sans-serif; font-weight: 900;
            color: #fbbf24; -webkit-text-stroke: 2px #b45309;
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0; transform: scale(0.5);
            font-size: 5rem;
        }
        @media (min-width: 768px) {
            .count-number { font-size: 8rem; }
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        
        /* ã‚«ãƒƒãƒˆã‚¤ãƒ³æ¼”å‡º */
        #cutin-msg {
            position: absolute; top: 30%; left: 0; right: 0; text-align: center;
            font-family: 'Mochiy+Pop+One', sans-serif; 
            color: #fff; text-shadow: 2px 2px 0 #ef4444, -2px -2px 0 #ef4444, 2px -2px 0 #ef4444, -2px 2px 0 #ef4444, 0 3px 6px rgba(0,0,0,0.5);
            z-index: 55; opacity: 0; transform: scale(0.8); pointer-events: none;
            padding: 0 10px; width: 100%;
            font-size: 3rem;
        }
        .cutin-anim { animation: cutIn 2s ease-out forwards; }
        @keyframes cutIn {
            0% { opacity: 0; transform: scale(0.5) rotate(-5deg); }
            10% { opacity: 1; transform: scale(1.2) rotate(0deg); }
            20% { transform: scale(1); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }

        /* ç´™å¹é›ª */
        .confetti-piece {
            position: absolute; width: 8px; height: 8px; background: #ffd700; top: -10px; z-index: 50;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ */
        #transition-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 70;
            display: flex; flex-col: column; align-items: center; justify-content: center;
            color: white; opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }

        /* äºˆæƒ³ã‚¹ãƒ­ãƒƒãƒˆ */
        .slot-box {
            background: #1f2937; border: 2px solid #374151; border-radius: 8px; padding: 2px; 
            text-align: center; color: white; 
            display: flex; flex-col: column; align-items: center; justify-content: center;
            min-height: 45px;
        }
        @media (min-width: 768px) {
            .slot-box { min-height: 60px; padding: 4px; }
        }
        .slot-active { border-color: #fbbf24; background: #374151; }
        .slot-filled { border-color: #9ca3af; background: #374151; }
        .slot-hidden { display: none !important; } 

        /* ãƒ¬ãƒ¼ã‚¹ä¸­ã®äºˆæƒ³è¡¨ç¤º */
        #race-bet-info {
            position: absolute; top: 8px; right: 8px; 
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px);
            padding: 6px; border-radius: 6px; color: white; z-index: 50; 
            pointer-events: none; border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.7rem; min-width: 120px;
        }
        @media (min-width: 768px) {
            #race-bet-info { padding: 8px; font-size: 0.8rem; min-width: 160px; top: 10px; right: 10px; }
        }
        .race-bet-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 4px;
        }
        .race-bet-row:last-child { margin-bottom: 0; }
        .race-bet-label { font-size: 0.6rem; padding: 1px 3px; border-radius: 2px; font-weight: bold; width: 40px; text-align: center; flex-shrink: 0; }
        @media (min-width: 768px) {
            .race-bet-label { font-size: 0.7rem; padding: 1px 4px; border-radius: 3px; width: 45px; }
        }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-0 md:p-4 text-gray-800 bg-gray-900">

    <div class="w-full max-w-5xl bg-white rounded-none md:rounded-xl shadow-2xl overflow-hidden border-0 md:border-4 border-yellow-600 relative flex flex-col h-full md:h-[720px] max-h-[100dvh]">
        
        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
        <div id="title-screen" class="absolute inset-0 z-[100] flex flex-col items-center justify-start bg-gradient-to-br from-indigo-900 via-purple-900 to-blue-900 text-white p-4 md:p-6 overflow-y-auto">
            
            <div class="w-full h-16 flex-shrink-0"></div>

            <div class="flex-grow flex flex-col items-center justify-center w-full min-h-[400px]">
                <div class="mb-4 mt-2 text-6xl md:text-7xl animate-bounce">ğŸ</div>
                <h1 class="text-4xl md:text-7xl font-pop text-yellow-400 mb-2 md:mb-4 drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] text-center leading-tight tracking-wider">
                    <div>THE LAST ONE</div>
                </h1>
                <div class="bg-pink-600 text-white font-bold px-4 py-1 md:px-6 md:py-2 rounded-full border-2 border-white shadow-lg transform -rotate-2 mb-8 text-sm md:text-xl">
                    ã€œ æ „å…‰ã®æœ€ä¸‹ä½ ã€œ
                </div>
                
                <div id="rule-box" class="bg-black/40 backdrop-blur-sm p-4 md:p-8 rounded-2xl border border-white/20 max-w-md text-center mb-8 shadow-xl w-full mx-4">
                    <h3 class="text-lg md:text-xl font-bold text-yellow-300 mb-2 md:mb-4 border-b border-white/30 pb-2">ãƒ«ãƒ¼ãƒ«èª¬æ˜</h3>
                    <p class="text-gray-200 text-sm md:text-base leading-relaxed">
                        æ™®é€šã®ç«¶é¦¬ã¨ã¯ä¸€å‘³é•ã†ï¼<br>
                        <span class="text-pink-300 font-bold">ã€Œé…ã„é¦¬ã€</span>ã‚’äºˆæƒ³ã™ã‚‹é€†è»¢ãƒ¬ãƒ¼ã‚¹ã‚²ãƒ¼ãƒ ã€‚<br>
                        ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§æŒ‘æˆ¦ã—ã‚ˆã†ï¼
                    </p>
                </div>

                <button id="title-start-btn" onclick="showModeSelect(); playSound('select');" class="bg-gradient-to-b from-yellow-400 to-yellow-600 hover:from-yellow-300 hover:to-yellow-500 text-purple-900 font-bold py-4 px-10 md:py-5 md:px-16 rounded-full text-xl md:text-2xl shadow-xl transform transition hover:scale-105 active:scale-95 border-4 border-white/50 mb-4">
                    ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ ğŸ®
                </button>

                <div id="mode-select-area" class="hidden flex flex-col gap-4 md:gap-6 w-full max-w-sm animate-fade-in px-2 mb-4">
                    <button onclick="selectMode('challenge')" class="bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-400 hover:to-blue-600 text-white font-bold py-3 px-5 md:py-4 md:px-6 rounded-xl shadow-lg border-2 border-blue-300 transform transition hover:scale-105 active:scale-95 text-left flex flex-col items-center">
                        <div class="text-lg md:text-xl mb-1">ğŸ ãƒ“ãƒªé¦¬ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
                        <div class="text-xs md:text-sm opacity-90 font-normal">å…¨3ã‚¹ãƒ†ãƒ¼ã‚¸ (é€†å˜å‹ã€œé€†3é€£å˜)</div>
                    </button>
                    <button onclick="selectMode('win5')" class="bg-gradient-to-r from-yellow-500 to-yellow-700 hover:from-yellow-400 hover:to-yellow-600 text-white font-bold py-3 px-5 md:py-4 md:px-6 rounded-xl shadow-lg border-2 border-yellow-300 transform transition hover:scale-105 active:scale-95 text-left flex flex-col items-center">
                        <div class="text-lg md:text-xl mb-1">ğŸ‘‘ é€†WIN5ãƒ¢ãƒ¼ãƒ‰</div>
                        <div class="text-xs md:text-sm opacity-90 font-normal">å…¨5ãƒ¬ãƒ¼ã‚¹é€£ç¶šã§æœ€ä¸‹ä½ã‚’å½“ã¦ã‚ï¼</div>
                    </button>
                    <button onclick="hideModeSelect(); playSound('select');" class="text-gray-300 text-sm underline mt-2 hover:text-white text-center w-full p-2">æˆ»ã‚‹</button>
                </div>
            </div>

            <!-- ãƒ•ãƒƒã‚¿ãƒ¼å‰Šé™¤ -->
        </div>

        <!-- 2. ãƒ¢ãƒ¼ãƒ‰åˆ¥ãƒ«ãƒ¼ãƒ«èª¬æ˜ -->
        <div id="mode-rule-screen" class="hidden absolute inset-0 z-[90] flex flex-col items-center justify-center bg-slate-900 text-white p-6 overflow-y-auto">
            <div class="max-w-md w-full bg-white/10 backdrop-blur-md p-6 rounded-3xl border border-white/20 shadow-2xl">
                <h2 id="mode-rule-title" class="text-2xl font-pop text-yellow-400 mb-4 text-center">ãƒ¢ãƒ¼ãƒ‰èª¬æ˜</h2>
                <div id="mode-rule-content" class="text-sm md:text-base leading-relaxed text-gray-200 mb-8 space-y-4"></div>
                <button onclick="startBetting(); playSound('select');" class="w-full bg-yellow-500 text-slate-900 font-bold py-4 rounded-xl shadow-lg transform transition hover:scale-105">ç†è§£ã—ãŸï¼æŒ‘æˆ¦ã™ã‚‹ ğŸ</button>
                <button onclick="showTitle(); playSound('select');" class="w-full mt-4 text-gray-400 text-sm underline text-center">ã‚„ã£ã±ã‚Šã‚„ã‚ã‚‹</button>
            </div>
        </div>

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div id="game-header" class="flex-shrink-0 bg-gradient-to-r from-blue-800 via-blue-600 to-blue-800 p-2 md:p-4 text-center border-b-2 md:border-b-4 border-blue-900 z-50 shadow-md flex justify-between items-center px-4 md:px-6 pr-4 transition-colors duration-500">
            <h1 class="text-sm md:text-2xl text-white font-pop tracking-wider flex items-center gap-2">
                <span>ğŸ¤”</span> <span id="header-title">Stage 1: é€†å˜å‹</span>
            </h1>
            <div id="header-rule" class="text-white text-[10px] md:text-sm opacity-90 border border-white/30 px-2 py-0.5 md:px-3 md:py-1 rounded whitespace-nowrap">æœ€ä¸‹ä½(5ç€)ã‚’å½“ã¦ã‚ï¼</div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ -->
        <div id="game-area" class="relative flex-grow bg-slate-100 overflow-hidden w-full h-full">
            
            <!-- 3. ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°ç”»é¢ -->
            <div id="betting-screen" class="p-4 md:p-6 flex flex-col items-center justify-start h-full w-full absolute inset-0 bg-slate-50 z-30 overflow-hidden">
                <div class="flex-shrink-0 w-full max-w-2xl bg-white p-3 md:p-4 rounded-xl shadow-md mb-2 md:mb-6 border border-gray-200 z-40">
                    <div id="instruction-text" class="text-center text-sm md:text-base font-bold text-gray-600 mb-2 md:mb-3">â–¼ æœ€ä¸‹ä½ã«ãªã‚‹é¦¬ã‚’1é ­é¸ã‚“ã§ãã ã•ã„ â–¼</div>
                    <div id="slots-container" class="grid grid-cols-1 gap-2 md:gap-4 mb-2 md:mb-4">
                        <div id="slot-5" class="slot-box min-h-[50px] md:min-h-[60px]">
                            <span class="text-[10px] md:text-xs text-purple-300 mb-0.5">5ç€(æœ€ä¸‹ä½)</span>
                            <span class="font-bold text-sm md:text-lg" id="slot-5-name">æœªé¸æŠ</span>
                        </div>
                        <div id="slot-4" class="slot-box slot-hidden min-h-[50px] md:min-h-[60px]">
                            <span class="text-[10px] md:text-xs text-emerald-300 mb-0.5">4ç€</span>
                            <span class="font-bold text-sm md:text-lg" id="slot-4-name">æœªé¸æŠ</span>
                        </div>
                        <div id="slot-3" class="slot-box slot-hidden min-h-[50px] md:min-h-[60px]">
                            <span class="text-[10px] md:text-xs text-pink-300 mb-0.5">3ç€</span>
                            <span class="font-bold text-sm md:text-lg" id="slot-3-name">æœªé¸æŠ</span>
                        </div>
                    </div>
                    <div class="flex gap-2 md:gap-4">
                        <button onclick="resetSelection(); playSound('select');" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 md:py-3 rounded-lg text-sm md:text-base transition shadow-md">ãƒªã‚»ãƒƒãƒˆ</button>
                        <button id="btn-start" onclick="confirmSelection(); playSound('select');" disabled class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-2 md:py-3 rounded-lg text-sm md:text-base transition shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">å‡ºèµ°ï¼</button>
                    </div>
                    <p class="text-[10px] md:text-xs text-gray-400 text-center mt-1 md:mt-2">â€»ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã§å…¨ã¦ã®é¸æŠã‚’è§£é™¤ã—ã€ã‚„ã‚Šç›´ã›ã¾ã™ã€‚</p>
                </div>
                <div class="w-full max-w-2xl flex-grow overflow-y-auto px-1 pb-10 md:pb-8">
                    <div id="horse-list" class="grid grid-cols-1 gap-2 md:gap-3"></div>
                </div>
            </div>

            <!-- ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ -->
            <div id="transition-overlay" class="bg-slate-900/95 flex flex-col items-center justify-center z-50">
                <div id="trans-title" class="text-2xl md:text-4xl mb-4 md:mb-8 font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-500 drop-shadow-sm tracking-wider">ã‚ãªãŸã®äºˆæƒ³</div>
                
                <div class="flex flex-col gap-3 md:gap-4 text-center w-full max-w-2xl px-4 md:px-6">
                    <div id="trans-row-5" class="p-3 rounded-xl bg-white/10 flex items-center gap-4"><span class="bg-purple-600 px-3 py-1 rounded-full text-xs font-bold">5ç€äºˆæƒ³</span><span id="trans-5" class="font-pop text-lg text-white"></span></div>
                    <div id="trans-row-4" class="hidden p-3 rounded-xl bg-white/10 flex items-center gap-4"><span class="bg-emerald-600 px-3 py-1 rounded-full text-xs font-bold">4ç€äºˆæƒ³</span><span id="trans-4" class="font-pop text-lg text-white"></span></div>
                    <div id="trans-row-3" class="hidden p-3 rounded-xl bg-white/10 flex items-center gap-4"><span class="bg-pink-600 px-3 py-1 rounded-full text-xs font-bold">3ç€äºˆæƒ³</span><span id="trans-3" class="font-pop text-lg text-white"></span></div>
                </div>
                <div class="mt-8 md:mt-12 text-lg md:text-2xl animate-pulse text-yellow-300 font-bold tracking-widest bg-black/30 px-5 py-2 rounded-full border border-yellow-500/30">çš„ä¸­ãªã‚‹ã‹...!?</div>
            </div>

            <!-- 4. ãƒ¬ãƒ¼ã‚¹ç”»é¢ -->
            <div id="race-screen" class="hidden absolute inset-0 w-full h-full z-10 stage-container">
                <div id="countdown-overlay"></div>
                <div id="cutin-msg"></div>
                <div id="race-bet-info">
                    <div class="text-[10px] md:text-xs text-gray-400 text-center mb-1 border-b border-gray-500 pb-1">ã‚ãªãŸã®äºˆæƒ³</div>
                    <div id="race-bet-list"></div>
                </div>
                <div class="sky-bg">
                    <div class="cloud" style="top: 10%; width: 100px; height: 30px; animation-duration: 25s;"></div>
                    <div class="cloud" style="top: 25%; width: 150px; height: 40px; animation-duration: 40s;"></div>
                </div>
                <div class="ground-plane" id="track-ground">
                    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ -->
                    <div class="start-line"></div>
                    <!-- ã‚´ãƒ¼ãƒ«ãƒ©ã‚¤ãƒ³ -->
                    <div class="goal-post-container">
                        <div class="finish-line"></div>
                        <div class="goal-post-pillar goal-pillar-left"></div>
                        <div class="goal-post-pillar goal-pillar-right"></div>
                        <div class="goal-banner">GOAL</div>
                    </div>
                    <div id="lanes-container" class="w-full h-full flex flex-col justify-start"></div>
                    <div id="dust-container" class="absolute inset-0 pointer-events-none w-full h-full"></div>
                </div>
            </div>

            <!-- 5. çµæœç”»é¢ -->
            <div id="result-screen" class="hidden absolute inset-0 bg-black/80 z-40 flex flex-col items-center justify-center p-4">
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-2xl text-center border-4 max-w-lg w-full transform flex flex-col max-h-[85vh]">
                    <div id="result-header" class="mb-4">
                        <div id="result-icon" class="text-5xl mb-2 animate-bounce">ğŸ‰</div>
                        <h2 id="result-title" class="text-2xl md:text-4xl font-bold font-pop">çš„ä¸­ï¼</h2>
                        <p id="result-message" class="text-sm md:text-base font-bold"></p>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-0 mb-4 text-left shadow-inner flex-grow overflow-y-auto border">
                        <div class="bg-gray-200 px-3 py-2 text-xs font-bold text-gray-600 sticky top-0 flex justify-between z-10">
                            <span>ãƒ¬ãƒ¼ã‚¹çµæœ (ä¸‹ä½ã‹ã‚‰)</span>
                            <span id="result-user-label">ã‚ãªãŸã®äºˆæƒ³</span>
                        </div>
                        <div id="ranking-list" class="flex flex-col"></div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <button id="btn-next-stage" onclick="nextStage(); playSound('select');" class="hidden w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">æ¬¡ã®ãƒ¬ãƒ¼ã‚¹ã¸é€²ã‚€ ğŸš€</button>
                        <button id="btn-retry-stage" onclick="retryGame(); playSound('select');" class="hidden w-full bg-gray-600 text-white font-bold py-3 rounded-xl shadow-lg">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹ ğŸ”„</button>
                        <button id="btn-reset-game" onclick="showTitle(); playSound('select');" class="hidden w-full bg-yellow-600 text-white font-bold py-3 rounded-xl shadow-lg">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹ ğŸ </button>
                    </div>
                </div>
            </div>
            <div id="confetti-container" class="absolute inset-0 overflow-hidden pointer-events-none z-50"></div>
        </div>
    </div>

    <script>
        class SimpleSynth {
            constructor() { this.ctx = null; }
            init() { if (!this.ctx) { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } }
            play(type) {
                this.init(); if (this.ctx.state === 'suspended') this.ctx.resume();
                const now = this.ctx.currentTime;
                switch(type) {
                    case 'select': this.osc(880, 'sine', 0.1, now); break;
                    case 'fanfare': const root = 523.25; this.osc(root, 'triangle', 0.1, now); this.osc(root, 'triangle', 0.1, now + 0.1); this.osc(root, 'triangle', 0.1, now + 0.2); this.osc(root * 1.5, 'triangle', 0.4, now + 0.3); break;
                    case 'start': const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.type = 'sawtooth'; o.frequency.setValueAtTime(150, now); g.gain.setValueAtTime(0.3, now); o.connect(g); g.connect(this.ctx.destination); o.start(now); o.stop(now + 0.3); break;
                    case 'win': [0, 0.1, 0.2, 0.3, 0.4].forEach((t, i) => this.osc(1000 + i * 200, 'sine', 0.2, now + t)); break;
                    case 'lose': this.osc(300, 'triangle', 0.3, now); this.osc(200, 'triangle', 0.4, now + 0.3); break;
                }
            }
            osc(freq, type, dur, time) { const o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.type = type; o.frequency.setValueAtTime(freq, time); g.gain.setValueAtTime(0.2, time); g.gain.exponentialRampToValueAtTime(0.01, time + dur); o.connect(g); g.connect(this.ctx.destination); o.start(time); o.stop(time + dur); }
        }

        let audio = new SimpleSynth(); 
        function playSound(type) { audio.play(type); }

        const kataFirst = ["ã‚¹ãƒ¼ãƒ‘ãƒ¼", "ã‚¦ãƒ«ãƒˆãƒ©", "ãƒã‚¤ãƒ‘ãƒ¼", "ã‚°ãƒ¬ãƒ¼ãƒˆ", "ãƒ¯ãƒ³ãƒ€ãƒ¼", "ã‚¯ãƒ¬ã‚¤ã‚¸ãƒ¼", "ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³", "ã‚·ãƒ£ã‚¤ãƒ‹ãƒ³ã‚°", "ãƒ¡ã‚¬ãƒˆãƒ³", "ã‚µãƒ³ãƒ€ãƒ¼", "ãƒ‰ãƒªãƒ¼ãƒ ", "ãƒ•ã‚¡ã‚¤ãƒŠãƒ«", "ãƒŸãƒƒãƒ‰ãƒŠã‚¤ãƒˆ", "ã‚­ãƒ³ã‚°", "ãƒ­ãƒãƒ³ã‚¹", "ãƒ€ã‚¤ãƒŠãƒã‚¤ãƒˆ", "ãƒ“ãƒƒã‚°", "ãƒãƒƒãƒ”ãƒ¼", "ãƒ©ãƒƒã‚­ãƒ¼", "ã‚¤ãƒŠã‚ºãƒ", "ã‚ªãƒ•ãƒˆã‚¥ãƒ³", "ã‚¿ãƒ”ã‚ªã‚«", "ãƒãƒƒã‚¹ãƒ«", "ã‚®ãƒ£ãƒ³ãƒ–ãƒ«", "ãƒœãƒ³ãƒ“ãƒ¼"];
        const kataSecond = ["ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ", "ãƒœãƒ³ãƒãƒ¼", "ãƒ©ãƒƒã‚·ãƒ¥", "ã‚¹ãƒˆãƒ¼ãƒ ", "ãƒ€ãƒ³ã‚¹", "ãƒœãƒ¼ã‚¤", "ã‚¬ãƒ¼ãƒ«", "ã‚¹ã‚¿ãƒ¼", "ã‚½ã‚¦ãƒ«", "ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹", "ãƒ‰ãƒ©ã‚´ãƒ³", "ã‚¿ã‚¤ã‚¬ãƒ¼", "ãƒ­ã‚±ãƒƒãƒˆ", "ã‚¦ã‚§ãƒ¼ãƒ–", "ãƒ‹ãƒ¼ãƒˆ", "ãƒ‘ãƒ³ãƒ", "ã‚­ãƒƒã‚¯", "ãƒ€ãƒƒã‚·ãƒ¥", "ã‚·ã‚¹ãƒ†ãƒ ", "ãƒ‡ãƒ©ãƒƒã‚¯ã‚¹", "ã‚¨ãƒ³ã‚¸ã‚§ãƒ«", "ãƒ‡ãƒ“ãƒ«", "ã‚µãƒ ãƒ©ã‚¤", "ãƒ‹ãƒ³ã‚¸ãƒ£", "ã‚¹ã‚·"];
        const horseStyles = [{ name: "é¹¿æ¯›", filter: "brightness(0.9) sepia(0.2)" }, { name: "é»’é¹¿æ¯›", filter: "brightness(0.4) grayscale(0.5)" }, { name: "èŠ¦æ¯›", filter: "grayscale(1) brightness(1.5)" }, { name: "æ —æ¯›", filter: "sepia(0.6) hue-rotate(-30deg) saturate(1.5)" }, { name: "ç™½æ¯›", filter: "grayscale(1) brightness(2.0)" }];
        const frameColors = [{ bg: "bg-white", text: "text-gray-900", border: "border-gray-400", hex: "#9ca3af" }, { bg: "bg-black", text: "text-white", border: "border-gray-800", hex: "#1f2937" }, { bg: "bg-red-600", text: "text-white", border: "border-red-600", hex: "#dc2626" }, { bg: "bg-blue-600", text: "text-white", border: "border-blue-600", hex: "#2563eb" }, { bg: "bg-yellow-400", text: "text-gray-900", border: "border-yellow-600", hex: "#ca8a04" }];

        const challengeRules = {
            1: { title: "Stage 1: é€†å˜å‹", sub: "æœ€ä¸‹ä½(5ç€)ã‚’1é ­å½“ã¦ã‚ï¼", color: "from-blue-800 via-blue-600 to-blue-800", borderColor: "border-blue-900", picks: 1 },
            2: { title: "Stage 2: é€†é¦¬å˜", sub: "5ç€â†’4ç€ã‚’é †ã«å½“ã¦ã‚ï¼", color: "from-green-800 via-green-600 to-green-800", borderColor: "border-green-900", picks: 2 },
            3: { title: "Stage 3: é€†3é€£å˜", sub: "5ç€â†’4ç€â†’3ç€ã‚’é †ã«å½“ã¦ã‚ï¼", color: "from-purple-800 via-purple-600 to-purple-800", borderColor: "border-purple-900", picks: 3 }
        };

        const win5Rule = { title: "é€†WIN5", sub: "5é ­ä¸­ã€æœ€ä¸‹ä½(5ç€)ã‚’å½“ã¦ã‚ï¼", color: "from-yellow-700 via-yellow-500 to-yellow-700", borderColor: "border-yellow-600", picks: 1 };

        let gameMode = 'challenge', currentStage = 1, horses = [], userSelections = [], isRacing = false, raceInterval = null, dustInterval = null;
        let screens, horseListEl, lanesContainerEl, dustContainerEl, countdownEl, gameAreaEl, rankingListEl, stageContainerEl, cutinEl, transOverlay, startBtn, raceBetListEl, headerEl, headerTitle, headerRule, instructionText, slots;

        window.onload = function() {
            screens = { title: document.getElementById('title-screen'), rule: document.getElementById('mode-rule-screen'), betting: document.getElementById('betting-screen'), race: document.getElementById('race-screen'), result: document.getElementById('result-screen') };
            horseListEl = document.getElementById('horse-list'); lanesContainerEl = document.getElementById('lanes-container'); dustContainerEl = document.getElementById('dust-container'); countdownEl = document.getElementById('countdown-overlay'); gameAreaEl = document.getElementById('game-area'); rankingListEl = document.getElementById('ranking-list'); stageContainerEl = document.querySelector('.stage-container'); cutinEl = document.getElementById('cutin-msg'); transOverlay = document.getElementById('transition-overlay'); startBtn = document.getElementById('btn-start'); raceBetListEl = document.getElementById('race-bet-list'); headerEl = document.getElementById('game-header'); headerTitle = document.getElementById('header-title'); headerRule = document.getElementById('header-rule'); instructionText = document.getElementById('instruction-text');
            slots = { 5: { box: document.getElementById('slot-5'), name: document.getElementById('slot-5-name') }, 4: { box: document.getElementById('slot-4'), name: document.getElementById('slot-4-name') }, 3: { box: document.getElementById('slot-3'), name: document.getElementById('slot-3-name') } };
            showTitle();
        };

        function showTitle() { switchScreen('title'); document.getElementById('title-start-btn').classList.remove('hidden'); document.getElementById('rule-box').classList.remove('hidden'); document.getElementById('mode-select-area').classList.add('hidden'); }
        function showModeSelect() { document.getElementById('title-start-btn').classList.add('hidden'); document.getElementById('rule-box').classList.add('hidden'); document.getElementById('mode-select-area').classList.remove('hidden'); }
        function hideModeSelect() { document.getElementById('title-start-btn').classList.remove('hidden'); document.getElementById('rule-box').classList.remove('hidden'); document.getElementById('mode-select-area').classList.add('hidden'); }
        function selectMode(mode) { gameMode = mode; currentStage = 1; showModeRules(); }

        function showModeRules() {
            switchScreen('rule');
            const titleEl = document.getElementById('mode-rule-title'), contentEl = document.getElementById('mode-rule-content');
            if (gameMode === 'win5') {
                titleEl.textContent = "é€†WIN5ãƒ¢ãƒ¼ãƒ‰ ãƒ«ãƒ¼ãƒ«";
                contentEl.innerHTML = `<p>æœ€ä¸‹ä½ã®é¦¬ã‚’å½“ã¦ç¶šã‘ã‚‹éé…·ãªã‚µãƒã‚¤ãƒãƒ«ï¼</p><ul class="list-disc pl-5"><li>å…¨5ãƒ¬ãƒ¼ã‚¹ã‚’é€£ç¶šã§çš„ä¸­ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</li><li>å„ãƒ¬ãƒ¼ã‚¹ã§5ç€(æœ€ä¸‹ä½)ã‚’1é ­äºˆæƒ³ã—ã¾ã™ã€‚</li><li>ä¸€åº¦ã§ã‚‚å¤–ã™ã¨ã€ç¬¬1ãƒ¬ãƒ¼ã‚¹ã‹ã‚‰ã‚„ã‚Šç›´ã—ã§ã™ã€‚</li></ul>`;
            } else {
                titleEl.textContent = "ãƒ“ãƒªé¦¬ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ãƒ«ãƒ¼ãƒ«";
                contentEl.innerHTML = `<p>é›£æ˜“åº¦ãŒä¸ŠãŒã‚‹3ã¤ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’æ”»ç•¥ï¼</p><ul class="list-disc pl-5"><li>Stage 1: 5ç€ã‚’1é ­çš„ä¸­ã€‚</li><li>Stage 2: 5ç€ã¨4ç€ã‚’é †ç•ªã«çš„ä¸­ã€‚</li><li>Stage 3: 5ç€ãƒ»4ç€ãƒ»3ç€ã‚’é †ç•ªã«çš„ä¸­ã€‚</li></ul>`;
            }
        }

        function startBetting() { initGame(); }

        function initGame() { 
            horses = []; userSelections = []; isRacing = false; clearInterval(raceInterval); clearInterval(dustInterval); 
            document.getElementById('confetti-container').innerHTML = ''; 
            cutinEl.textContent = ""; cutinEl.classList.remove('cutin-anim');
            setupStageUI(); updateSlots(); switchScreen('betting'); 
            const usedNames = new Set(); for (let i = 0; i < 5; i++) horses.push(createHorse(i, usedNames)); renderBettingList(); 
        }

        function retryGame() { if (gameMode === 'win5') currentStage = 1; initGame(); }

        function setupStageUI() {
            let picks = gameMode === 'win5' ? 1 : challengeRules[currentStage].picks;
            const rule = gameMode === 'win5' ? win5Rule : challengeRules[currentStage];
            headerTitle.textContent = gameMode === 'win5' ? `é€†WIN5: ç¬¬${currentStage}ãƒ¬ãƒ¼ã‚¹` : rule.title;
            headerRule.textContent = rule.sub;
            headerEl.className = `flex-shrink-0 bg-gradient-to-r ${rule.color} p-2 md:p-4 text-center border-b-2 md:border-b-4 ${rule.borderColor} z-50 shadow-md flex justify-between items-center px-4 md:px-6 transition-colors duration-500 flex-shrink-0 pr-4`;
            instructionText.textContent = picks === 1 ? "æœ€ä¸‹ä½(5ç€)ã‚’1é ­é¸ã‚“ã§ãã ã•ã„" : (picks === 2 ? "5ç€ã€4ç€ã‚’é †ç•ªã«é¸ã‚“ã§ãã ã•ã„" : "5ç€ã€4ç€ã€3ç€ã‚’é †ç•ªã«é¸ã‚“ã§ãã ã•ã„");
            
            // ã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤ºåˆ¶å¾¡
            if(slots[5].box) slots[5].box.style.display = 'flex';
            if(slots[4].box) {
                if (picks >= 2) {
                    slots[4].box.style.display = 'flex';
                    slots[4].box.classList.remove('slot-hidden');
                } else {
                    slots[4].box.style.display = 'none';
                    slots[4].box.classList.add('slot-hidden');
                }
            }

            if(slots[3].box) {
                if (picks >= 3) {
                    slots[3].box.style.display = 'flex';
                    slots[3].box.classList.remove('slot-hidden');
                } else {
                    slots[3].box.style.display = 'none';
                    slots[3].box.classList.add('slot-hidden');
                }
            }

            const grid = document.getElementById('slots-container');
            if (grid) {
                grid.className = ''; 
                let colsClass = 'grid-cols-3';
                if (picks === 1) colsClass = 'grid-cols-1';
                else if (picks === 2) colsClass = 'grid-cols-2';
                
                requestAnimationFrame(() => {
                    grid.className = `grid ${colsClass} gap-2 md:gap-4 mb-2 md:mb-4`;
                });
            }
        }

        function nextStage() {
            const maxStage = (gameMode === 'win5') ? 5 : 3;
            if (currentStage < maxStage) {
                currentStage++;
                initGame();
            }
        }

        function createHorse(index, usedNames) {
            let name = "";
            while (true) {
                const f = kataFirst[Math.floor(Math.random() * kataFirst.length)], s = kataSecond[Math.floor(Math.random() * kataSecond.length)], n = f + s;
                if (!usedNames.has(n)) { name = n; usedNames.add(name); break; }
            }
            const style = horseStyles[Math.floor(Math.random() * horseStyles.length)];
            
            // --- èƒ½åŠ›ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (ã‚·ãƒ³ãƒ—ãƒ«åŒ–) ---
            const speedBase = 0.4 + Math.random() * 0.25; 
            const noise = (Math.random() - 0.5) * 0.2; 
            const observedSpeed = speedBase + noise;

            let condition = "normal";
            let effectIcon = "";
            
            if (observedSpeed > 0.6) { condition = "best"; effectIcon = "ğŸ”¥"; }
            else if (observedSpeed > 0.5) { condition = "good"; effectIcon = "âœ¨"; }
            else if (observedSpeed < 0.45) { condition = "bad"; effectIcon = "ğŸ˜°"; }

            return {
                id: index, name: name, icon: "ğŸ", style: style, frameColor: frameColors[index],
                position: 5, 
                speedBase: speedBase, 
                stamina: Math.random(), 
                spurt: Math.random() < 0.4, 
                rank: null, finished: false, condition: condition, effectIcon: effectIcon 
            };
        }

        function renderBettingList() {
            horseListEl.innerHTML = '';
            horses.forEach(horse => {
                const btn = document.createElement('button');
                btn.id = `btn-horse-${horse.id}`;
                const hoverClass = gameMode === 'win5' ? 'hover:bg-yellow-100' : 'hover:bg-opacity-50';
                btn.className = `w-full flex items-center justify-between p-3 rounded-lg border-l-8 ${hoverClass} transition shadow-sm bg-white mb-2 relative overflow-hidden group ${horse.frameColor.border}`;
                btn.onclick = () => { selectHorse(horse); playSound('select'); };
                
                let animClass = horse.condition === "best" ? "condition-best" : (horse.condition === "good" ? "condition-good" : (horse.condition === "bad" ? "condition-bad" : "")), condColor = horse.condition === "best" ? "text-red-600 font-bold" : (horse.condition === "good" ? "text-orange-500 font-bold" : (horse.condition === "bad" ? "text-blue-500" : "text-gray-500"));
                btn.innerHTML = `<div class="flex items-center space-x-4 z-10 flex-grow"><div class="w-8 h-8 rounded-full flex items-center justify-center font-bold shadow-sm ${horse.frameColor.bg} ${horse.frameColor.text} border border-gray-400 text-sm flex-shrink-0">${horse.id + 1}</div><div class="text-left flex-grow"><div class="font-bold text-gray-800 text-lg leading-tight font-pop group-hover:text-blue-600 transition-colors">${horse.name}</div><div class="text-xs md:text-sm ${condColor} mt-1">èª¿å­:${horse.condition === "best" ? "çµ¶å¥½èª¿!!" : (horse.condition === "good" ? "å¥½èª¿" : (horse.condition === "bad" ? "ä¸èª¿..." : "æ™®é€š"))}</div></div></div><div class="relative w-12 flex justify-center flex-shrink-0"><div class="text-3xl filter drop-shadow-sm ${animClass}" style="filter: ${horse.style.filter}">${horse.icon}</div>${horse.effectIcon ? `<div class="effect-icon">${horse.effectIcon}</div>` : ''}</div><div id="badge-horse-${horse.id}" class="hidden"></div>`;
                horseListEl.appendChild(btn);
            });
            updateListBadges();
        }

        function getPicksNeeded() {
            if (gameMode === 'win5') return 1;
            return challengeRules[currentStage].picks;
        }

        function selectHorse(horse) {
            const picksNeeded = getPicksNeeded();
            if (userSelections.includes(horse.id)) return;
            if (userSelections.length < picksNeeded) {
                userSelections.push(horse.id);
                updateSlots();
                updateListBadges();
            }
        }

        function resetSelection() {
            userSelections = [];
            updateSlots();
            updateListBadges();
        }

        function updateSlots() {
            [5, 4, 3].forEach(rank => {
                if(slots[rank].box) {
                    slots[rank].box.classList.remove('slot-filled');
                    slots[rank].name.textContent = "æœªé¸æŠ";
                    slots[rank].name.classList.remove('text-white');
                }
            });
            
            const picksNeeded = getPicksNeeded();
            const remaining = picksNeeded - userSelections.length;
            startBtn.disabled = remaining > 0;
            startBtn.className = `flex-1 ${remaining === 0 ? 'bg-blue-600' : 'bg-gray-300'} text-white font-bold py-2 rounded-lg text-sm`;
            startBtn.textContent = remaining > 0 ? `ã‚ã¨${remaining}é ­` : "å‡ºèµ°ï¼";

            if (userSelections.length > 0 && slots[5].box) {
                const h = horses.find(h => h.id === userSelections[0]);
                slots[5].name.textContent = h.name;
                slots[5].box.classList.add('slot-filled');
                slots[5].name.classList.add('text-white');
            }
            if (userSelections.length > 1 && (gameMode !== 'win5' && currentStage >= 2) && slots[4].box) {
                const h = horses.find(h => h.id === userSelections[1]);
                slots[4].name.textContent = h.name;
                slots[4].box.classList.add('slot-filled');
                slots[4].name.classList.add('text-white');
            }
            if (userSelections.length > 2 && (gameMode !== 'win5' && currentStage >= 3) && slots[3].box) {
                const h = horses.find(h => h.id === userSelections[2]);
                slots[3].name.textContent = h.name;
                slots[3].box.classList.add('slot-filled');
                slots[3].name.classList.add('text-white');
            }
        }

        function updateListBadges() {
            horses.forEach(h => {
                const badgeEl = document.getElementById(`badge-horse-${h.id}`);
                const btnEl = document.getElementById(`btn-horse-${h.id}`);
                if(!badgeEl || !btnEl) return;
                
                const idx = userSelections.indexOf(h.id);
                btnEl.classList.remove('ring-2', 'ring-purple-500', 'ring-emerald-500', 'ring-pink-500', 'bg-purple-50', 'bg-emerald-50', 'bg-pink-50');
                
                if (idx !== -1) {
                    let badgeBg = "", ringColor = "", btnBg = "", text = "";
                    if (idx === 0) { text = "5ç€äºˆæƒ³"; badgeBg = "bg-purple-600"; ringColor = "ring-purple-500"; btnBg = "bg-purple-50"; }
                    else if (idx === 1) { text = "4ç€äºˆæƒ³"; badgeBg = "bg-emerald-600"; ringColor = "ring-emerald-500"; btnBg = "bg-emerald-50"; }
                    else { text = "3ç€äºˆæƒ³"; badgeBg = "bg-pink-600"; ringColor = "ring-pink-500"; btnBg = "bg-pink-50"; }

                    badgeEl.className = `absolute top-1 right-1 px-2 py-0.5 rounded text-[10px] font-bold text-white shadow-md z-20 border border-white ${badgeBg}`;
                    badgeEl.textContent = text;
                    badgeEl.classList.remove('hidden');
                    btnEl.classList.add('ring-2', ringColor, btnBg);
                } else {
                    badgeEl.className = "hidden";
                }
            });
        }

        function confirmSelection() {
            transOverlay.style.opacity = '1'; transOverlay.style.pointerEvents = 'auto';
            document.getElementById('trans-title').textContent = (gameMode === 'win5' ? `é€†WIN5 ç¬¬${currentStage}æˆ¦ äºˆæƒ³` : challengeRules[currentStage].title + " äºˆæƒ³");
            document.getElementById('trans-5').textContent = horses.find(h => h.id === userSelections[0]).name;
            const picks = getPicksNeeded();
            if(picks >= 2) { document.getElementById('trans-row-4').classList.replace('hidden', 'flex'); document.getElementById('trans-4').textContent = horses.find(h => h.id === userSelections[1]).name; } else { document.getElementById('trans-row-4').classList.replace('flex', 'hidden'); }
            if(picks >= 3) { document.getElementById('trans-row-3').classList.replace('hidden', 'flex'); document.getElementById('trans-3').textContent = horses.find(h => h.id === userSelections[2]).name; } else { document.getElementById('trans-row-3').classList.replace('flex', 'hidden'); }
            setTimeout(() => { transOverlay.style.opacity = '0'; transOverlay.style.pointerEvents = 'none'; startRace(); }, 2500);
        }

        function startRace() {
            switchScreen('race'); setup3DTrack(); playSound('fanfare');
            cutinEl.textContent = ""; cutinEl.classList.remove('cutin-anim');
            raceBetListEl.innerHTML = '';
            const labels = [{t:"5ç€",b:"bg-purple-600",id:userSelections[0]}, {t:"4ç€",b:"bg-emerald-600",id:userSelections[1]}, {t:"3ç€",b:"bg-pink-600",id:userSelections[2]}].slice(0, getPicksNeeded());
            labels.forEach(item => { const h = horses.find(horse => horse.id === item.id), row = document.createElement('div'); row.className = "race-bet-row"; row.innerHTML = `<span class="race-bet-label ${item.b}">${item.t}</span><div class="flex items-center ml-2 overflow-hidden justify-end w-full"><span class="flex-shrink-0 w-4 h-4 rounded-full flex items-center justify-center ${h.frameColor.bg} ${h.frameColor.text} border border-gray-400 text-[10px] mr-1 font-bold shadow-sm">${h.id + 1}</span><span class="truncate font-pop text-right">${h.name}</span></div>`; raceBetListEl.appendChild(row); });
            let count = 3; countdownEl.innerHTML = '';
            const timer = setInterval(() => {
                if (count > 0) { const s = document.createElement('span'); s.className = 'count-number'; s.textContent = count; countdownEl.innerHTML = ''; countdownEl.appendChild(s); playSound('select'); }
                else if (count === 0) { const s = document.createElement('span'); s.className = 'count-number'; s.textContent = "GO!"; countdownEl.innerHTML = ''; countdownEl.appendChild(s); playSound('start'); }
                else { clearInterval(timer); countdownEl.innerHTML = ''; isRacing = true; runRaceLoop(); startDustEffect(); }
                count--;
            }, 1000);
        }

        function setup3DTrack() {
            lanesContainerEl.innerHTML = ''; dustContainerEl.innerHTML = '';
            horses.forEach((horse, index) => {
                const lane = document.createElement('div'); lane.className = "lane"; lane.style.zIndex = index + 10;
                const actor = document.createElement('div'); actor.id = `horse-actor-${horse.id}`; actor.className = "horse-actor"; actor.style.left = "0%"; 
                // updateHorseVisuals ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€å¹ãå‡ºã—ã‚„ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã®IDã‚’æŒã¤è¦ç´ ã‚’ä½œæˆã—ã¦ãŠã
                actor.innerHTML = `
                    <div class="horse-billboard">
                        <div class="name-label" style="border-color: ${horse.frameColor.hex};"><span class="name-number ${horse.frameColor.bg} ${horse.frameColor.text}">${horse.id+1}</span><span>${horse.name}</span></div>
                        <div class="galloping-sprite" style="filter: ${horse.style.filter}; animation-duration: ${0.3 + Math.random()*0.05}s">${horse.icon}</div>
                        <div class="horse-shadow"></div>
                    </div>`;
                lane.appendChild(actor); lanesContainerEl.appendChild(lane);
            });
        }

        function startDustEffect() {
            dustInterval = setInterval(() => { if (!isRacing) return; horses.forEach(horse => { if (horse.finished) return; const dust = document.createElement('div'); dust.className = 'absolute bg-green-900 rounded-full opacity-40 pointer-events-none'; const size = 5 + Math.random() * 8; dust.style.width = size+'px'; dust.style.height = size+'px'; dust.style.top = `${(horse.id * 20) + 10 + (Math.random() * 5)}%`; dust.style.left = `${horse.position - 4}%`; dust.animate([{ transform: 'scale(0.5)', opacity: 0.6 }, { transform: 'translate(-40px, -10px) scale(2)', opacity: 0 }], { duration: 600, fill: 'forwards' }); dustContainerEl.appendChild(dust); setTimeout(() => dust.remove(), 600); }); }, 100);
        }

        function updateHorseVisuals(horse) {
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰åŒ–ãŒå‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ã“ã®é–¢æ•°ã¯ç©ºã¾ãŸã¯æœ€å°é™ã®å‡¦ç†ã«ã™ã‚‹
            // ã‚¢ã‚¤ã‚³ãƒ³ã‚„å¹ãå‡ºã—ã®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ã¯ä¸è¦ã«ãªã£ãŸãŸã‚å‰Šé™¤
        }

        function runRaceLoop() {
            const goal = 92; // ã‚´ãƒ¼ãƒ«åˆ¤å®šä½ç½®
            let nextRank = 1;

            raceInterval = setInterval(() => {
                if (!isRacing) return;
                
                horses.forEach(horse => {
                    if (horse.finished) {
                        // ã‚´ãƒ¼ãƒ«å¾Œã¯ç”»é¢å¤–ã¸èµ°ã‚Šå»ã‚‹
                        horse.position += 0.5; 
                        const actor = document.getElementById(`horse-actor-${horse.id}`);
                        if(actor) actor.style.left = `${Math.min(horse.position, 150)}%`;
                        return;
                    }

                    // ã‚·ãƒ³ãƒ—ãƒ«ãªé€Ÿåº¦è¨ˆç®—: åŸºæœ¬é€Ÿåº¦ + ãƒ©ãƒ³ãƒ€ãƒ ãªæºã‚‰ã
                    // çŠ¶æ…‹ç•°å¸¸(sleep, panicç­‰)ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å…¨ã¦å‰Šé™¤
                    let step = horse.speedBase + (Math.random() - 0.5) * 0.2;
                    
                    // ã‚¹ã‚¿ãƒŸãƒŠã«ã‚ˆã‚‹å¾ŒåŠã®å¤±é€Ÿï¼ˆå°‘ã—ã ã‘æ®‹ã™ï¼‰
                    if (horse.position > 60 && horse.stamina < 0.3) {
                        step -= 0.05; 
                    }
                    
                    // æœ€ä½é€Ÿåº¦ä¿è¨¼ï¼ˆå®Œå…¨ã«æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
                    if (step < 0.05) step = 0.05;

                    horse.position += step;
                    
                    const actor = document.getElementById(`horse-actor-${horse.id}`);
                    if (actor) actor.style.left = `${Math.min(horse.position, 150)}%`;
                    
                    // ã‚´ãƒ¼ãƒ«åˆ¤å®š
                    if (horse.position >= goal) {
                        horse.finished = true; 
                        horse.rank = nextRank;
                        nextRank++;
                    }
                });
                
                // å…¨é ­ã‚´ãƒ¼ãƒ«åˆ¤å®š
                const allFinished = horses.every(h => h.finished);
                
                if (allFinished) { 
                    cutinEl.textContent = "GOAL!!"; 
                    cutinEl.classList.add('cutin-anim');
                    
                    isRacing = false; 
                    clearInterval(raceInterval); 
                    clearInterval(dustInterval); 
                    setTimeout(showResult, 2500); 
                }
            }, 50);
        }

        function showResult() {
            switchScreen('result');
            const sorted = [...horses].sort((a, b) => b.rank - a.rank);
            const r5 = sorted[0], r4 = sorted[1], r3 = sorted[2];
            let win = false; const max = (gameMode === 'win5') ? 5 : 3;
            if (gameMode === 'win5') win = (userSelections[0] === r5.id); 
            else {
                if (currentStage === 1) win = (userSelections[0] === r5.id);
                else if (currentStage === 2) win = (userSelections[0] === r5.id && userSelections[1] === r4.id);
                else if (currentStage === 3) win = (userSelections[0] === r5.id && userSelections[1] === r4.id && userSelections[2] === r3.id);
            }
            const tc = gameMode === 'win5' ? 'text-yellow-600' : (currentStage === 2 ? 'text-green-600' : (currentStage === 3 ? 'text-purple-600' : 'text-blue-600')), bt = win ? 'border-blue-500' : 'border-gray-500';
            document.querySelector('#result-screen > div').className = `bg-white p-4 md:p-6 rounded-2xl shadow-2xl text-center border-4 ${bt} max-w-lg w-full transform scale-100 transition-transform flex flex-col max-h-[85vh] z-50`;
            document.getElementById('result-user-label').className = tc + ' font-bold';
            const resIcon = document.getElementById('result-icon'), resTitle = document.getElementById('result-title'), resMsg = document.getElementById('result-message'), btnNext = document.getElementById('btn-next-stage'), btnRetry = document.getElementById('btn-retry-stage'), btnReset = document.getElementById('btn-reset-game');
            btnNext.classList.add('hidden'); btnRetry.classList.add('hidden'); btnReset.classList.add('hidden');
            resIcon.textContent = win ? "ğŸ‘‘" : "ğŸ˜­"; resTitle.textContent = win ? "çš„ä¸­ï¼" : "æ®‹å¿µ..."; resTitle.className = `text-2xl md:text-4xl font-bold mb-1 font-pop ${win ? tc + ' animate-bounce' : 'text-gray-600'}`;
            if (win) {
                playSound('win'); startConfetti(); resMsg.textContent = currentStage < max ? (gameMode === 'win5' ? `ç¬¬${currentStage}ãƒ¬ãƒ¼ã‚¹çªç ´ï¼` : `ã‚¹ãƒ†ãƒ¼ã‚¸${currentStage}ã‚¯ãƒªã‚¢ï¼`) : `å…¨ã‚¹ãƒ†ãƒ¼ã‚¸å®Œå…¨åˆ¶è¦‡ï¼`;
                if (currentStage < max) { btnNext.classList.remove('hidden'); } else { btnReset.classList.remove('hidden'); }
            } else {
                playSound('lose'); resMsg.textContent = gameMode === 'win5' ? "ä¸çš„ä¸­... ç¬¬1ãƒ¬ãƒ¼ã‚¹ã‹ã‚‰ã‚„ã‚Šç›´ã—ã§ã™" : "äºˆæƒ³å¤–ã‚Œã¾ã—ãŸ...";
                btnRetry.classList.remove('hidden'); btnReset.classList.remove('hidden');
            }
            rankingListEl.innerHTML = '';
            sorted.forEach(horse => {
                const idx = userSelections.indexOf(horse.id); let corr = (horse.rank === 5 && idx === 0) || (horse.rank === 4 && idx === 1) || (horse.rank === 3 && idx === 2);
                const row = document.createElement('div'); row.className = `p-3 border-b flex items-center justify-between ${corr ? 'bg-yellow-50' : ''}`; 
                // truncateã‚’å‰Šé™¤ã—ã€é¦¬åãŒå…¨ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«å¤‰æ›´
                row.innerHTML = `<div class="flex items-center gap-3 overflow-hidden"><span class="font-bold text-xl w-12 text-center text-gray-700 flex-shrink-0">${horse.rank}ç€</span><div class="flex flex-col overflow-hidden"><span class="font-bold text-lg text-gray-800">${horse.name}</span></div></div><div class="text-sm font-bold ${corr ? 'text-blue-600' : 'text-gray-400'} flex-shrink-0 ml-2">${idx !== -1 ? (idx === 0 ? "5ç€" : (idx === 1 ? "4ç€" : "3ç€")) + "äºˆæƒ³" + (corr ? "ğŸ¯" : "âŒ") : ""}</div>`; rankingListEl.appendChild(row);
            });
        }

        function startConfetti() { const container = document.getElementById('confetti-container'); const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff']; for (let i = 0; i < 100; i++) { const conf = document.createElement('div'); conf.className = 'confetti-piece'; conf.style.left = Math.random() * 100 + '%'; conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; conf.animate([ { transform: `translate(0, -10px) rotate(0deg)`, opacity: 1 }, { transform: `translate(${Math.random()*100 - 50}px, 600px) rotate(${Math.random()*720}deg)`, opacity: 0 } ], { duration: Math.random() * 2000 + 1500, iterations: Infinity }); container.appendChild(conf); } }
        function switchScreen(name) { Object.values(screens).forEach(s => s?.classList.add('hidden')); if(screens[name]) screens[name].classList.remove('hidden'); }
        function nextStage() { currentStage++; initGame(); }
    </script>
</body>
</html>
